networks:
  tmind-net:

volumes:
  tminddb:
  influxdb:
  rabbitmq:
  qdrant:

services:

  # ===================== DATABASES / INFRA =====================

  tmind-sql:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "${SA_PASSWORD}"
    volumes:
      - tminddb:/var/opt/mssql
    ports:
      - "1433:1433"
    networks: [tmind-net]
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/127.0.0.1/1433' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  influxdb:
    image: influxdb:2.7
    ports:
      - "8086:8086"
    volumes:
      - influxdb:/var/lib/influxdb2
    networks: [tmind-net]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBIT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBIT_PASS}
    ports:
      - "5672"
      - "15672:15672"
    volumes:
      - rabbitmq:/var/lib/rabbitmq
    networks: [tmind-net]
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant:/qdrant/storage
    networks: [tmind-net]
    healthcheck:
      test:
        - CMD
        - /bin/bash
        - -c
        - "echo > /dev/tcp/127.0.0.1/6333"
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s



  # ===================== BACKEND SERVICES (DEV) =====================

  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile.dev
    volumes:
      - ./services/auth-service:/app
    working_dir: /app 
    ports:
      - "5001:5001"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__AuthDbConnection: >
        Server=tmind-sql,1433;
        Database=TmindDB2Auth;
        User Id=sa;
        Password=${SA_PASSWORD};
        TrustServerCertificate=True;
      Jwt__Key: ${JWT_KEY}
      Jwt__Issuer: AssetNodeAPI
      Jwt__Audience: AssetNodeClient
    depends_on:
      tmind-sql:
        condition: service_healthy
    networks: [tmind-net]

  device-service:
    build:
      context: ./services/device-service
      dockerfile: Dockerfile.dev
    volumes:
      - ./services/device-service:/app
    ports:
      - "5002:5002"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
    depends_on:
      tmind-sql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks: [tmind-net]

  asset-service:
    build:
      context: ./services/asset-service
      dockerfile: Dockerfile.dev
    volumes:
      - ./services/asset-service:/app
    ports:
      - "5003:5003"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
    depends_on:
      tmind-sql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    networks: [tmind-net]

  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile.dev
    volumes:
      - ./gateway:/app
    ports:
      - "5000:5000"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
    depends_on:
      auth-service:
        condition: service_healthy
      device-service:
        condition: service_healthy
      asset-service:
        condition: service_healthy
    networks: [tmind-net]

  # ===================== AI SERVER (NODE - DEV) =====================

  ai-server:
    build:
      context: ./ai-server
      dockerfile: Dockerfile.dev
    volumes:
      - ./ai-server:/app
      - /app/node_modules
    ports:
      - "5004:5004"
    environment:
      NODE_ENV: development
      PORT: 5004
      SQL_SERVER_HOST: tmind-sql
      SQL_SERVER_DB: TmindDB2Asset
      SQL_SERVER_USER: sa
      SQL_SERVER_PASSWORD: ${SA_PASSWORD}
      INFLUX_URL: http://influxdb:8086
      INFLUX_TOKEN: ${INFLUX_TOKEN}
      INFLUX_ORG: ${INFLUX_ORG}
      INFLUX_BUCKET: ${INFLUX_BUCKET}
      GROQ_API_KEY: ${GROQ_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
    depends_on:
      tmind-sql:
        condition: service_healthy
      influxdb:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    networks: [tmind-net]

  # ===================== FRONTEND (VITE - DEV) =====================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:5000
    depends_on:
      gateway:
        condition: service_healthy
    networks: [tmind-net]
